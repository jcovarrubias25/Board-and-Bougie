<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>The Rustic Board</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@700&display=swap');
        
        :root { --primary: #7a5cfa; --wood: #d2b48c; --bark: #bc9d70; --danger: #ff4757; --success: #2ecc71; --paper: #fffcf2; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        
        body { font-family: 'Fredoka One', cursive; background: #fdfaf5; margin: 0; padding: 0; overflow: hidden; height: 100vh; display: flex; justify-content: center; }

        #game-container { 
            width: 100%; 
            max-width: 480px;
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            padding: 8px;
            gap: 2px;
        }
        
        #story-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.96); z-index: 100; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .story-box { background: var(--paper); padding: 35px; border-radius: 45px; border: 10px solid var(--primary); width: 100%; text-align: center; box-shadow: 0 20px 0 rgba(0,0,0,0.2); }
        .story-box h2 { font-size: 32px; color: var(--primary); margin: 10px 0; }
        .story-box p { font-family: 'Quicksand', sans-serif; font-size: 20px; font-weight: 700; line-height: 1.4; color: #444; }

        .top-bar { display: flex; justify-content: space-between; align-items: center; background: white; padding: 6px 12px; border-radius: 12px; border: 1px solid #eee; font-size: 14px; }

        .order-card { background: white; padding: 10px; border-radius: 18px; border: 4px solid var(--primary); }
        #order-details { font-family: 'Quicksand', sans-serif; font-size: 15px; font-weight: 700; display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px; }
        .req-chip { background: #f0edff; padding: 3px 8px; border-radius: 8px; color: var(--primary); border: 1px solid #dcd3ff; }

        .play-area { 
            display: flex; 
            align-items: center; 
            justify-content: center;
            padding: 10px 0;
            background: #f9f4ef;
            border-radius: 20px;
            gap: 12px;
        }
        
        .board { 
            width: 240px; 
            height: 140px; 
            background: var(--wood); 
            border: 9px solid var(--bark); 
            border-radius: 35px; 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            align-content: center; 
            gap: 4px; 
            padding: 8px; 
            box-shadow: inset 0 0 20px rgba(0,0,0,0.3); 
        }

        .timer-side { text-align: center; min-width: 60px; }

        .tray { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr);
            gap: 5px; 
            padding: 10px; 
            background: white; 
            border-radius: 18px; 
            border: 2px solid #eee;
        }
        .item { font-size: 36px; cursor: pointer; user-select: none; text-align: center; }

        .big-btn { background: var(--primary); color: white; border: none; padding: 25px; border-radius: 60px; font-size: 28px; box-shadow: 0 10px 0 #5a3ec7; width: 100%; cursor: pointer; font-family: 'Fredoka One'; margin-top: 15px; }
        
        button#serve-btn { 
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 18px; 
            border-radius: 40px; 
            font-size: 24px; 
            box-shadow: 0 8px 0 #5a3ec7; 
            width: 100%; 
            cursor: pointer;
            margin-top: 4px; 
        }
        
        .money-text { color: var(--success); font-weight: bold; font-size: 22px; }
    </style>
</head>
<body>

<div id="story-overlay"><div class="story-box" id="story-content"></div></div>

<div id="game-container">
    <div class="top-bar">
        <div>Record: $<span id="high-score-val">0.00</span></div>
        <div id="lives-display" style="font-size: 18px;">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>

    <div class="order-card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="color:var(--primary); font-size: 20px;">Board #<span id="level-num">1</span></span>
            <span class="money-text">$<span id="score-display">0.00</span></span>
        </div>
        <div id="order-details"></div>
    </div>

    <div class="play-area">
        <div class="board" id="board"></div>
        <div class="timer-side">
            <div style="font-size: 24px;">‚è≤Ô∏è</div>
            <div id="timer-text" style="font-family: monospace; font-size: 16px; font-weight: 900;">0.00s</div>
        </div>
    </div>

    <div class="tray" id="tray"></div>
    <button id="serve-btn" onclick="submitBoard()">SERVE ‚ú®</button>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playSound(type) {
        const now = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        if (type === 'tap') { 
            osc.type = 'triangle'; osc.frequency.setValueAtTime(150, now);
            gain.gain.setValueAtTime(0.4, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(); osc.stop(now + 0.1);
        } else if (type === 'remove') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(100, now);
            gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
            osc.start(); osc.stop(now + 0.05);
        } else if (type === 'cash') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(1800, now + 0.05);
            gain.gain.setValueAtTime(0.1, now + 0.05); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            osc.start(now + 0.05); osc.stop(now + 0.4);
        } else if (type === 'ding') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(900, now);
            gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
            osc.start(); osc.stop(now + 0.5);
        } else if (type === 'buzzer') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(60, now);
            gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.8);
            osc.start(); osc.stop(now + 0.8);
        } else if (type === 'hint') {
            osc.type = 'square'; osc.frequency.setValueAtTime(120, now);
            gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
            osc.start(); osc.stop(now + 0.2);
        }
    }

    let currentLevel = 0, bankAccount = 0, highScore = localStorage.getItem('rusticBoardHighScore') || 0, lives = 3, timerInterval, timeLeft;
    const chefMayaTag = '<span style="font-size:80px">üë©üèæ‚Äçüç≥</span><br><span style="color:var(--primary); font-size: 24px;">Chef Maya</span>';

    const milestones = {
        0: "Welcome! I'm Maya. I've dreamt of opening this shop since I was a little girl. Let's prep our very first board!",
        1: "Perfect start! Every board we sell brings us closer to getting that neon sign for the window.",
        2: "The smell of fresh bread is starting to fill the shop. People are peering in the windows!",
        3: "A local food blogger just walked in. No pressure, right?",
        4: "Whew! They loved it. My phone won't stop buzzing with notifications.",
        5: "Business is picking up! I might need to order more fancy honey jars soon.",
        10: "Milestone! We just got featured in the local paper. The 'Maya Special' is a hit!",
        20: "I've finally saved enough for a top-of-the-line walk-in fridge. Look at all this space!",
        50: "Can you believe it? Maya's Board Shop is now a local celebrity hotspot!"
    };

    const fillerStories = [
        "That cheese pairing was genius!", "The customer said this was the best bread they've had all year.",
        "I love the way you arranged those fruits.", "We're becoming the talk of the neighborhood!",
        "Quick work! My grandmother always said speed is the secret ingredient.",
        "That garnish really made the board pop!", "The meats today are particularly fresh, good choice."
    ];

    const pantryItems = [
        {e:'üßÄ', t:'cheese'}, {e:'üßà', t:'cheese'}, {e:'ü•ö', t:'egg'}, {e:'ü•©', t:'meat'}, {e:'ü•ì', t:'meat'}, {e:'üçó', t:'meat'}, {e:'üçñ', t:'meat'},
        {e:'ü•®', t:'bread'}, {e:'ü•ñ', t:'bread'}, {e:'ü•ê', t:'bread'}, {e:'üçû', t:'bread'}, {e:'ü•Ø', t:'bread'}, {e:'üçá', t:'fruit'}, {e:'üçì', t:'fruit'},
        {e:'ü´ê', t:'fruit'}, {e:'üçç', t:'fruit'}, {e:'üçí', t:'fruit'}, {e:'üç´', t:'sweet'}, {e:'üç™', t:'sweet'}, {e:'üç©', t:'sweet'}, {e:'üßÅ', t:'sweet'},
        {e:'ü´í', t:'olive'}, {e:'ü•í', t:'olive'}, {e:'ü•ï', t:'veg'}, {e:'üçÖ', t:'veg'}, {e:'üåΩ', t:'veg'}, {e:'üå∂Ô∏è', t:'veg'}, {e:'ü•¶', t:'veg'},
        {e:'ü•ú', t:'nut'}, {e:'üå∞', t:'nut'}, {e:'üåø', t:'garnish'}, {e:'üçÉ', t:'garnish'}, {e:'ü¶ê', t:'meat'}, {e:'üç£', t:'meat'}, {e:'üçØ', t:'sweet'}
    ];

    const levels = [];
    const types = ['cheese', 'meat', 'bread', 'fruit', 'sweet', 'olive', 'garnish', 'veg', 'nut', 'egg'];
    for(let i=1; i<=100; i++) {
        let diff = Math.min(Math.floor(i / 10) + 2, 5); let r = {}; let shuffled = [...types].sort(() => 0.5 - Math.random());
        for(let j=0; j<diff; j++) { r[shuffled[j]] = Math.floor(Math.random() * 2) + 1; }
        levels.push({ t: 15, r: r, p: 20 + (i * 5) });
    }

    function showStory(mode = "prologue", earnings = 0) {
        const overlay = document.getElementById('story-overlay');
        const content = document.getElementById('story-content');
        overlay.style.display = 'flex';
        
        if (mode === "prologue") {
            content.innerHTML = `${chefMayaTag}<h2>Grand Opening</h2><p>${milestones[0]}</p><button class="big-btn" onclick="startAudio(); showStory('level')">OPEN SHOP</button>`;
        } else if (lives <= 0) {
            content.innerHTML = `<h2>Closing Time</h2><p>Maya: 'We did our best today. Let's try again tomorrow!'<br><br>Final Earnings: $${bankAccount.toFixed(2)}</p><button class="big-btn" onclick="resetGame()">RESTART JOURNEY</button>`;
        } else if (mode === "success") {
            let story = milestones[currentLevel] || fillerStories[Math.floor(Math.random() * fillerStories.length)];
            content.innerHTML = `${chefMayaTag}<h2>Excellent!</h2><p>${story}</p><p style="color:var(--success)">+$${earnings.toFixed(2)}</p><button class="big-btn" onclick="playSound('cash'); showStory('level')">NEXT ORDER</button>`;
        } else if (mode === "fail") {
            content.innerHTML = `${chefMayaTag}<h2>Oh No!</h2><p>That customer was in a hurry. Let's try to be a bit faster on the next one!</p><button class="big-btn" onclick="showStory('level')">CONTINUE</button>`;
        } else {
            overlay.style.display = 'none'; startLevel();
        }
    }

    function startAudio() { if (audioCtx.state === 'suspended') audioCtx.resume(); }

    function renderTray() {
        const tray = document.getElementById('tray'); tray.innerHTML = '';
        pantryItems.forEach(item => {
            const d = document.createElement('div');
            d.className = 'item'; d.innerHTML = item.e;
            d.onclick = () => {
                playSound('tap');
                const bItem = document.createElement('div');
                bItem.className = 'item'; bItem.innerHTML = item.e; bItem.dataset.type = item.t;
                bItem.onclick = () => { playSound('remove'); bItem.remove(); };
                document.getElementById('board').appendChild(bItem);
            };
            tray.appendChild(d);
        });
    }

    function startLevel() {
        const d = levels[currentLevel]; timeLeft = d.t * 100;
        document.getElementById('level-num').innerText = (currentLevel + 1);
        document.getElementById('board').innerHTML = ''; renderTray();
        let dets = ""; for (let k in d.r) dets += `<span class="req-chip">${d.r[k]}x ${k.toUpperCase()}</span>`;
        document.getElementById('order-details').innerHTML = dets;
        startTimer();
    }

    function startTimer() {
        clearInterval(timerInterval);
        const txt = document.getElementById('timer-text');
        timerInterval = setInterval(() => {
            timeLeft--; txt.innerText = (timeLeft / 100).toFixed(2) + "s";
            txt.style.color = timeLeft < 500 ? 'var(--danger)' : '#333';
            if (timeLeft <= 0) { 
                clearInterval(timerInterval); playSound('buzzer'); 
                lives--; 
                document.getElementById('lives-display').innerText = "‚ù§Ô∏è".repeat(lives) + "üñ§".repeat(3 - lives); 
                showStory('fail'); 
            }
        }, 10);
    }

    function submitBoard() {
        const d = levels[currentLevel]; const items = document.querySelectorAll('#board .item');
        let counts = {}; items.forEach(i => { counts[i.dataset.type] = (counts[i.dataset.type] || 0) + 1; });
        let error = null;
        for (let k in d.r) { if ((counts[k] || 0) < d.r[k]) { error = `Need more ${k.toUpperCase()}!`; break; } if ((counts[k] || 0) > d.r[k]) { error = `Too much ${k.toUpperCase()}!`; break; } }
        if (!error) { for (let k in counts) { if (!d.r[k]) { error = `No ${k.toUpperCase()}!`; break; } } }

        if (!error) {
            clearInterval(timerInterval); playSound('ding');
            let earned = d.p + (timeLeft/100); bankAccount += earned;
            document.getElementById('score-display').innerText = bankAccount.toFixed(2);
            currentLevel++; showStory("success", earned);
        } else {
            playSound('hint');
            const btn = document.getElementById('serve-btn');
            btn.style.background = 'var(--danger)'; btn.innerText = error;
            setTimeout(() => { btn.innerText = "SERVE ‚ú®"; btn.style.background = 'var(--primary)'; }, 1000);
        }
    }

    function resetGame() { currentLevel = 0; bankAccount = 0; lives = 3; document.getElementById('score-display').innerText = "0.00"; document.getElementById('lives-display').innerText = "‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è"; showStory('prologue'); }
    document.getElementById('high-score-val').innerText = parseFloat(highScore).toFixed(2);
    showStory('prologue');
</script>
</body>
</html>
